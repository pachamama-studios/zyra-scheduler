name: Zyra EUMETSAT Geostationary Pipeline (Dataspace API)

on:
  workflow_dispatch:
    inputs:
      DATASET_NAME:
        description: "Dataset name (e.g., eumetsat)"
        required: true
        type: string
      ZYRA_VERBOSITY:
        description: "Log level (debug|info|quiet)"
        required: false
        default: info
        type: choice
        options: [debug, info, quiet]

env:
  ZYRA_SCHEDULER_IMAGE: "ghcr.io/noaa-gsl/zyra-scheduler:latest"
  ZYRA_VERBOSITY: "${{ inputs.ZYRA_VERBOSITY }}"

jobs:

  ############################################
  # 1. Acquire latest Meteosat imagery
  ############################################
  acquire-eumetsat:
    name: Acquire Geostationary Imagery
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/noaa-gsl/zyra-scheduler:latest
      options: >-
        --entrypoint ""
        --user 0

    env:
      DATASET_NAME: "${{ inputs.DATASET_NAME }}"
      EUMETSAT_USERNAME: ${{ secrets.EUMETSAT_USERNAME }}
      EUMETSAT_PASSWORD: ${{ secrets.EUMETSAT_PASSWORD }}

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (EUMETSAT Dataspace + Zyra)
        run: |
          apt-get update && apt-get install -y git
          pip install --no-cache-dir 'zyra[datatransfer]'
          pip install git+https://gitlab.eumetsat.int/open-source-public/eumdac-dataspace.git

      - name: Acquire Meteosat imagery (Dataspace API)
        run: |
          python3 <<'PYCODE'
          import os
          from datetime import datetime, timedelta
          from eumdac_dataspace import DataStore

          username = os.environ["EUMETSAT_USERNAME"]
          password = os.environ["EUMETSAT_PASSWORD"]

          datastore = DataStore(username, password)
          print("‚úÖ Authenticated with EUMETSAT Dataspace API")

          collection_id = "EO:EUM:DAT:MSG:HRSEVIRI"
          collection = datastore.get_collection(collection_id)

          # Search the last 6 hours of data
          end = datetime.utcnow()
          start = end - timedelta(hours=6)
          products = list(collection.search(dtstart=start, dtend=end))

          if not products:
              print("‚ö†Ô∏è No SEVIRI products found in last 6 hours.")
              exit(0)

          print(f"Found {len(products)} products in the last 6 hours.")
          product = products[0]
          print(f"üì¶ Product ID: {product.identifier}")

          dataset_name = os.environ.get("DATASET_NAME", "eumetsat")
          output_dir = f"_work/images/{dataset_name}"
          os.makedirs(output_dir, exist_ok=True)
          dest = os.path.join(output_dir, f"{product.identifier}.zip")

          print(f"‚¨áÔ∏è Downloading ‚Üí {dest}")
          with product.open() as src, open(dest, "wb") as dst:
              dst.write(src.read())
          print(f"‚úÖ Download complete: {dest}")
          PYCODE

      - name: Install unzip utility
        run: apt-get update && apt-get install -y unzip

      - name: Extract imagery frames
        run: |
          echo "üì¶ Extracting downloaded EUMETSAT product..."
          mkdir -p "_work/images/${{ inputs.DATASET_NAME }}/frames"
          find "_work/images/${{ inputs.DATASET_NAME }}" -type f -name "*.zip" | while read zf; do
            echo "üóúÔ∏è  Unzipping $zf"
            unzip -q -o "$zf" -d "_work/images/${{ inputs.DATASET_NAME }}/frames"
          done
          echo "üß≠ Listing extracted files:"
          find "_work/images/${{ inputs.DATASET_NAME }}/frames" -type f | head -20 || true
          echo "‚úÖ Extraction complete."

      - name: Upload acquire artifacts
        uses: actions/upload-artifact@v4
        with:
          name: acquire-${{ inputs.DATASET_NAME }}
          path: _work/images/${{ inputs.DATASET_NAME }}
          retention-days: 7


  ############################################
  # 2. Validate imagery frames
  ############################################
  validate-frames:
    name: Validate imagery
    runs-on: ubuntu-latest
    needs: [acquire-eumetsat]
    container:
      image: ghcr.io/noaa-gsl/zyra-scheduler:latest
      options: >-
        --entrypoint ""
        --user 0

    steps:
      - uses: actions/checkout@v4

      - name: Restore imagery
        uses: actions/download-artifact@v4
        with:
          name: acquire-${{ inputs.DATASET_NAME }}
          path: _work/images/${{ inputs.DATASET_NAME }}

      - name: Validate imagery frames
        run: |
          zyra transform metadata \
            --frames-dir "_work/images/${{ inputs.DATASET_NAME }}" \
            --output "_work/images/${{ inputs.DATASET_NAME }}/metadata.json"

      - name: Upload metadata
        uses: actions/upload-artifact@v4
        with:
          name: metadata-${{ inputs.DATASET_NAME }}
          path: _work/images/${{ inputs.DATASET_NAME }}/metadata.json


  ############################################
  # 3. Compose animation from frames
  ############################################
  compose-video:
    name: Compose video
    runs-on: ubuntu-latest
    needs: [validate-frames]
    container:
      image: ghcr.io/noaa-gsl/zyra-scheduler:latest
      options: >-
        --entrypoint ""
        --user 0

    steps:
      - uses: actions/checkout@v4

      - name: Restore imagery
        uses: actions/download-artifact@v4
        with:
          name: acquire-${{ inputs.DATASET_NAME }}
          path: _work/images/${{ inputs.DATASET_NAME }}

      - name: Flatten frame directory for Zyra
        run: |
          mkdir -p "_work/images/${{ inputs.DATASET_NAME }}/flat"
          find "_work/images/${{ inputs.DATASET_NAME }}/frames" -type f \( -iname "*.png" -o -iname "*.jpg" \) \
            -exec cp {} "_work/images/${{ inputs.DATASET_NAME }}/flat/" \; || true
          echo "üß≠ Flattened frame list:"
          ls -1 "_work/images/${{ inputs.DATASET_NAME }}/flat" | head -10 || true

      - name: Compose animation
        run: |
          mkdir -p _work/output
          echo "üéûÔ∏è Composing animation..."
          if [ -z "$(ls -A _work/images/${{ inputs.DATASET_NAME }}/flat 2>/dev/null)" ]; then
            echo "‚ö†Ô∏è No frame images found. Skipping composition."
            exit 0
          fi
          zyra visualize compose-video \
            --frames "_work/images/${{ inputs.DATASET_NAME }}/flat" \
            --output "_work/output/${{ inputs.DATASET_NAME }}.mp4"

      - name: Upload video artifact
        if: success() || always()
        uses: actions/upload-artifact@v4
        with:
          name: video-${{ inputs.DATASET_NAME }}
          path: _work/output/${{ inputs.DATASET_NAME }}.mp4
          retention-days: 7


  ############################################
  # 4. Upload to Vimeo
  ############################################
  upload-vimeo:
    name: Upload to Vimeo
    runs-on: ubuntu-latest
    needs: [compose-video]
    container:
      image: ghcr.io/noaa-gsl/zyra-scheduler:latest
      options: >-
        --entrypoint ""
        --user 0

    env:
      VIMEO_CLIENT_ID: ${{ secrets.VIMEO_CLIENT_ID }}
      VIMEO_CLIENT_SECRET: ${{ secrets.VIMEO_CLIENT_SECRET }}
      VIMEO_ACCESS_TOKEN: ${{ secrets.VIMEO_ACCESS_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - name: Ensure Zyra Vimeo connector installed
        run: pip install --no-cache-dir 'zyra[datatransfer]'

      - name: Restore video
        uses: actions/download-artifact@v4
        with:
          name: video-${{ inputs.DATASET_NAME }}
          path: _work/output
          continue-on-error: true

      - name: Upload to Vimeo
        run: |
          if [ ! -f "_work/output/${{ inputs.DATASET_NAME }}.mp4" ]; then
            echo "‚ö†Ô∏è No MP4 file found; skipping Vimeo upload."
            exit 0
          fi
          zyra decimate vimeo \
            --input "_work/output/${{ inputs.DATASET_NAME }}.mp4" \
            --replace-uri ${VIMEO_URI:-/videos/your-video-id}
