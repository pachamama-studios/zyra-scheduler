name: Zyra EUMETSAT Geostationary Pipeline

on:
   workflow_dispatch:
    inputs:
      DATASET_NAME:
        description: "Dataset name (e.g., eumetsat)"
        required: true
        type: string
      ZYRA_VERBOSITY:
        description: "Log level (debug|info|quiet)"
        required: false
        default: info
        type: choice
        options: [debug, info, quiet]

env:
  ZYRA_SCHEDULER_IMAGE: "ghcr.io/noaa-gsl/zyra-scheduler:latest"
  ZYRA_VERBOSITY: "${{ inputs.ZYRA_VERBOSITY }}"

jobs:
  acquire-eumetsat:
    name: Acquire Geostationary Imagery
    runs-on: ubuntu-latest
    container:
      image: "${{ env.ZYRA_SCHEDULER_IMAGE }}"
      options: >-
        --entrypoint ""
        --user 0

    env:
      EUMETSAT_API_KEY: ${{ secrets.EUMETSAT_API_KEY }}
      EUMETSAT_API_SECRET: ${{ secrets.EUMETSAT_API_SECRET }}
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (EUMDAC + Zyra)
        run: pip install --no-cache-dir 'zyra[datatransfer]' eumdac

      - name: Acquire Meteosat imagery from EUMETSAT
        run: |
          python3 <<'PYCODE'
          import eumdac, os
          from datetime import datetime, timedelta

          consumer_key = os.environ["EUMETSAT_API_KEY"]
          consumer_secret = os.environ["EUMETSAT_API_SECRET"]

          token = eumdac.AccessToken((consumer_key, consumer_secret))
          print("✅ Authenticated with EUMETSAT API")

          datastore = eumdac.DataStore(token)

          # Meteosat-11 SEVIRI (HR Visible) product
          collection_id = "EO:EUM:DAT:MSG:HRSEVIRI"
          collection = datastore.get_collection(collection_id)

          # Last 6 hours of data
          end = datetime.utcnow()
          start = end - timedelta(hours=6)
          products = list(collection.search(start=start, end=end))

          if not products:
              print("⚠️ No SEVIRI products found in last 6h.")
              exit(0)

          latest = products[0]
          os.makedirs(f"_work/images/${{ inputs.DATASET_NAME }}", exist_ok=True)
          dest = f"_work/images/${{ inputs.DATASET_NAME }}/{latest.filename}"

          print(f"⬇️  Downloading {latest.filename} ...")
          with latest.open() as src, open(dest, "wb") as dst:
              dst.write(src.read())

          print(f"✅ Downloaded {latest.filename}")
          PYCODE

      - name: Upload acquire artifacts
        uses: actions/upload-artifact@v4
        with:
          name: acquire-${{ inputs.DATASET_NAME }}
          path: _work/images/${{ inputs.DATASET_NAME }}
          retention-days: 7

  validate-frames:
    name: Validate imagery
    runs-on: ubuntu-latest
    needs: [acquire-eumetsat]
    container:
      image: ${{ env.ZYRA_SCHEDULER_IMAGE }}
      options: >-
        --entrypoint ""
        --user 0
    steps:
      - uses: actions/checkout@v4

      - name: Restore imagery
        uses: actions/download-artifact@v4
        with:
          name: acquire-${{ inputs.DATASET_NAME }}
          path: _work/images/${{ inputs.DATASET_NAME }}

      - name: Validate imagery frames
        run: |
          zyra transform metadata \
            --frames-dir "_work/images/${{ inputs.DATASET_NAME }}" \
            --output "_work/images/${{ inputs.DATASET_NAME }}/metadata.json"

      - name: Upload metadata
        uses: actions/upload-artifact@v4
        with:
          name: metadata-${{ inputs.DATASET_NAME }}
          path: _work/images/${{ inputs.DATASET_NAME }}/metadata.json

  compose-video:
    name: Compose video
    runs-on: ubuntu-latest
    needs: [validate-frames]
    container:
      image: ${{ env.ZYRA_SCHEDULER_IMAGE }}
      options: >-
        --entrypoint ""
        --user 0
    steps:
      - uses: actions/checkout@v4

      - name: Restore imagery
        uses: actions/download-artifact@v4
        with:
          name: acquire-${{ inputs.DATASET_NAME }}
          path: _work/images/${{ inputs.DATASET_NAME }}

      - name: Compose animation
        run: |
          mkdir -p _work/output
          zyra visualize compose-video \
            --frames "_work/images/${{ inputs.DATASET_NAME }}" \
            --output "_work/output/${{ inputs.DATASET_NAME }}.mp4"

      - name: Upload video artifact
        uses: actions/upload-artifact@v4
        with:
          name: video-${{ inputs.DATASET_NAME }}
          path: _work/output/${{ inputs.DATASET_NAME }}.mp4

  upload-vimeo:
    name: Upload to Vimeo
    runs-on: ubuntu-latest
    needs: [compose-video]
    container:
      image: ${{ env.ZYRA_SCHEDULER_IMAGE }}
      options: >-
        --entrypoint ""
        --user 0
    env:
      VIMEO_CLIENT_ID: ${{ secrets.VIMEO_CLIENT_ID }}
      VIMEO_CLIENT_SECRET: ${{ secrets.VIMEO_CLIENT_SECRET }}
      VIMEO_ACCESS_TOKEN: ${{ secrets.VIMEO_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Ensure Zyra Vimeo connector installed
        run: pip install --no-cache-dir 'zyra[datatransfer]'

      - name: Restore video
        uses: actions/download-artifact@v4
        with:
          name: video-${{ inputs.DATASET_NAME }}
          path: _work/output

      - name: Upload to Vimeo
        run: |
          zyra decimate vimeo \
            --input "_work/output/${{ inputs.DATASET_NAME }}.mp4" \
            --replace-uri ${VIMEO_URI:-/videos/your-video-id}
