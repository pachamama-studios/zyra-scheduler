name: Zyra Copernicus Acquire

on:
  workflow_dispatch:
    inputs:
      DATASET_NAME:
        description: Dataset name (e.g., copernicus)
        required: true
        type: string

env:
  ZYRA_SCHEDULER_IMAGE: ghcr.io/noaa-gsl/zyra-scheduler:latest

jobs:
  acquire-copernicus:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/noaa-gsl/zyra-scheduler:latest
      options: >-
        --entrypoint ""
        --user 0
    env:
      COPERNICUS_USERNAME: ${{ secrets.COPERNICUS_USERNAME }}
      COPERNICUS_PASSWORD: ${{ secrets.COPERNICUS_PASSWORD }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Copernicus Dataspace client
        run: pip install --no-cache-dir 'zyra[datatransfer]' copernicusdataspace
      
      - name: Acquire imagery from Copernicus Dataspace (API)
        run: |
          python3 <<'PYCODE'
          from copernicusdataspace import CDSAPI
          from datetime import datetime, timedelta
          import os
      
          api = CDSAPI(
              username=os.environ["COPERNICUS_USERNAME"],
              password=os.environ["COPERNICUS_PASSWORD"]
          )
      
          end = datetime.utcnow()
          start = end - timedelta(hours=8)
      
          products = api.search(
              platform="Sentinel-1",
              productType="SLC",
              startDate=start,
              completionDate=end,
              geometry={
                  "type": "Polygon",
                  "coordinates": [[[-120, 35], [-118, 35], [-118, 37], [-120, 37], [-120, 35]]]
              },
              limit=3
          )
      
          print(f"Found {len(products)} products")
      
          os.makedirs("_work/images/${DATASET_NAME}", exist_ok=True)
      
          for p in products:
              print(f"Downloading {p['title']} ...")
              api.download(p["id"], f"_work/images/${DATASET_NAME}")
          PYCODE
        env:
          COPERNICUS_USERNAME: ${{ secrets.COPERNICUS_USERNAME }}
          COPERNICUS_PASSWORD: ${{ secrets.COPERNICUS_PASSWORD }}




      - name: Upload imagery artifacts
        uses: actions/upload-artifact@v4
        with:
          name: copernicus-${{ inputs.DATASET_NAME }}
          path: _work/images/${{ inputs.DATASET_NAME }}
