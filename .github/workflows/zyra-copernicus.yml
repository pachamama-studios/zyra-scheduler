name: Zyra Copernicus Acquire

on:
  workflow_dispatch:
    inputs:
      DATASET_NAME:
        description: Dataset name (e.g., copernicus)
        required: true
        type: string

env:
  ZYRA_SCHEDULER_IMAGE: ghcr.io/noaa-gsl/zyra-scheduler:latest

jobs:
  acquire-copernicus:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/noaa-gsl/zyra-scheduler:latest
      options: >-
        --entrypoint ""
        --user 0
    env:
      COPERNICUS_USERNAME: ${{ secrets.COPERNICUS_USERNAME }}
      COPERNICUS_PASSWORD: ${{ secrets.COPERNICUS_PASSWORD }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Copernicus connector (temporary)
        run: pip install 'zyra[datatransfer]' sentinelsat

      - name: Acquire imagery from Copernicus (API)
        run: |
          python3 <<'PYCODE'
          from sentinelsat import SentinelAPI
          from datetime import datetime, timedelta
          import os
      
          api = SentinelAPI(
              os.environ["COPERNICUS_USERNAME"],
              os.environ["COPERNICUS_PASSWORD"],
              "https://apihub.copernicus.eu/apihub"
          )
      
          # Use datetime objects
          end = datetime.utcnow()
          start = end - timedelta(hours=8)
      
          footprint = 'POLYGON((-120 35, -118 35, -118 37, -120 37, -120 35))'
      
          products = api.query(
              area=footprint,
              date=(start, end),
              platformname="Sentinel-1",
              producttype="SLC"
          )
      
          os.makedirs("_work/images/${DATASET_NAME}", exist_ok=True)
      
          if products:
              uuid = next(iter(products))
              print(f"Downloading product {uuid} ...")
              api.download(uuid, directory_path=f"_work/images/${DATASET_NAME}")
          else:
              print("No products found for given query.")
          PYCODE
        env:
          COPERNICUS_USERNAME: ${{ secrets.COPERNICUS_USERNAME }}
          COPERNICUS_PASSWORD: ${{ secrets.COPERNICUS_PASSWORD }}



      - name: Upload imagery artifacts
        uses: actions/upload-artifact@v4
        with:
          name: copernicus-${{ inputs.DATASET_NAME }}
          path: _work/images/${{ inputs.DATASET_NAME }}
